{% capture cartHTML %}
<div class="minicart">
  <div class="minicart__entries fancy-scroll">
    <h3 class="h-reset minicart__title">{{'cart.page.title' | t}} <span>({{cart.item_count}})</span><span class="minicart__close" onclick="BoosterTheme.cart.close()">Close</span></h3>
    {% if settings.cartTimer and cart.items.size > 0 %}
      <div class="minicart__timer" data-countdown data-ct-key="cart-ct-timer" data-duration="{{settings.cartTimerDuration}}" data-duration-format="minutes">
          <span>{{'cart.page.expires'|t}}</span> <span class="minutes">00</span>:<span class="seconds">00</span>
      </div>
    {% endif %}
    {% assign cart_product = '' %}
    
    {% for item in cart.items %}
      {% assign cart_product = cart_product | append: item.product_id | append: ',' %}
      <div class="minicart__entry">
        <a class="card__img--container minicart__image"  href="{{ item.url | within: collections.all }}">
          <div class="card__img--ratio">
            <div class="card__img">
              <img src="{{item | img_url: 'medium'}}" alt="{{item.title | escape }}">
            </div>
          </div>
        </a>

        <div class="minicart__info">
          <a href="{{ item.url }}">{{ item.product.title }}</a>
          {% if settings.minicartVariantOptions %}

            {% if item.product.variants.size > 1 %}
              <select class="minicart__variant-dropdown" data-variant-id="{{ item.key }}" onchange="BoosterTheme.cart.updateVariant(event, '{{ item.variant_id }}')">
                {% for variant_option in item.product.variants %}
                  {% if variant_option.available %}
                    <option value="{{ variant_option.id }}" {% if variant_option.id == item.variant_id %}selected{% endif %} {% if variant_option.id == item.variant_id %}disabled{% endif %}>
                      {{ variant_option.title }}
                    </option>
                  {% else %}
                    <option disabled>{{ variant_option.title }} - {{'general.buttons.sold_out' | t}}</option>
                  {% endif %}
                {% endfor %}
              </select>
            {% else %}
              <span class="minicart__variation">{% unless item.product.has_only_default_variant %}{{ item.variant.title }}{% endunless %}</span>
            {% endif %}

          {% else %}
            
            <span class="minicart__variation">{% unless item.product.has_only_default_variant %}{{ item.variant.title }}{% endunless %}</span>
            {% for property_name in item.properties %}
              {% if property_name.last != '' %}
                <span class="cart__info--properties">
                    {{ property_name.first }}:      
                    {% if property_name.last contains '/uploads/' %}
                        <a href="{{ property_name.last }}">{{ property_name.last | split: '/' | last }}</a>
                    {% else %}
                            {{ property_name.last }}
                    {% endif %}
                </span>
              {% endif %}
            {% endfor %}

          {% endif %}
          
          <span class="minicart__price">
            <span class="jsPrice">{{ item.price | money | strip_html }}</span> 

            {%- if item.original_line_price != item.line_price -%}
              <div>
                (<s class="jsPrice">{{ item.original_line_price | money | strip_html }}</s>
                  
                  <span class="jsPrice">{{- item.line_price | money | strip_html -}}</span>)
              </div>
            {%- endif -%}

            {%- for discount in item.discounts -%}{{- discount.title -}}{%- endfor -%}
          </span>
          {% if settings.quantity_selector %}
          <div class="quantity--input">
            <button class="quantity--input__button quantity--input__incr" onclick="BoosterTheme.cart.quantityHandler(event, false)">-</button><!--
            --><input class="quantity--input__input" value={{item.quantity}} data-qty-input data-qty-int-input data-variant-id={{item.key}} onchange="BoosterTheme.cart.updateQuantity(event)" type="number" min="0" {% if item.variant.inventory_management and item.variant.inventory_policy != "continue" %}max="{{ item.variant.inventory_quantity}}"{% endif%}><!--
            --><button class="quantity--input__button quantity--input__decr" onclick="BoosterTheme.cart.quantityHandler(event, true)">+</button>
          </div>
          {% endif %}
        </div>
        <span class="minicart__trash" onclick="BoosterTheme.cart.removeFromCart(this, '{{item.variant_id}}')">{% render 'get-icon', icon: 'trash' %}</span>
      </div>
    {% else %}
      <div style="text-align: center;">
      <a href="{{routes.all_products_collection_url}}" class="empty__cart--icon" aria-label="Your cart is empty">{% render 'get-icon', icon: 'shopping-bag' %}</a>
      <div class="empty__cart--title">{{'minicart.empty_text' | t }}</div>
        {% assign trantext = 'minicart.empty_button' | t %}
        {% liquid
          assign checkout_url = ''
          if settings.checkout_offering_url_minicart != blank 
              assign checkout_url = settings.checkout_offering_url_minicart 
          else 
              assign checkout_url = routes.all_products_collection_url 
          endif
      %}
        {% render 'button', type: 'primary', text: trantext, url: checkout_url %}
      </div>
    {% endfor %}

    {% if settings.miniCartUpsell and cart.items.size > 0 and settings.miniCartUpsellCollection  %}
      <style>
        :root { --cartupsell-bg-color: {{ settings.upsellBgColor }}; }

        .minicart__upsell {
          border-top: {{ settings.upsellBorderWidth }}px {{ settings.upsellBorderStyle }} {{ settings.upsellBorderColor }};
          border-bottom: {{ settings.upsellBorderWidth }}px {{ settings.upsellBorderStyle }} {{ settings.upsellBorderColor }};
        }

        .minicart__upsell .minicart__upsell--header p,
        .minicart__upsell .minicart__info > *,
        .minicart__upsell .jsPrice {
          color: {% if settings.upsellTextColor != 'rgba(0,0,0,0)' %}{{ settings.upsellTextColor }}{% else %}var(--textColor){% endif %} !important;  
        } 
      </style>

      {% assign hasProduct = false %}
      {% for miniCartUpsellProduct in settings.miniCartUpsellCollection.products %}
        {% if cart_product contains miniCartUpsellProduct.id %}
          {% assign hasProduct = true %}
        {% else %}
        {% assign hasProduct = false %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless hasProduct %}
        <div class="minicart__upsell">
          <div class="minicart__upsell--header">
              <p> {{ settings.miniCartUpsellHeading }} </p>
          </div>
          {% assign length = settings.miniCartUpsellProductLength %}
          {% assign total_products = settings.miniCartUpsellCollection.products.size %}
          {% assign max_start = total_products | minus: length %}
          {% assign start_index = "now" | date: "%S" | modulo: max_start %}
          {% assign products_shown = 0 %}
          {% for miniCartUpsellProduct in settings.miniCartUpsellCollection.products %}

            {% if forloop.index0 >= start_index %}
              {% unless cart_product contains miniCartUpsellProduct.id %} 
                <div class="minicart__entry minicart__upsell--entry">
                  <a class="card__img--container minicart__image"  href="{{ miniCartUpsellProduct.url | within: collections.all }}">
                    <div class="card__img--ratio">
                      <div class="card__img">
                        <img src="{{ miniCartUpsellProduct.featured_image | img_url: 'medium'}}" alt="{{miniCartUpsellProduct.title | escape }}">
                      </div>
                    </div>
                  </a>
                  <div class="minicart__info">
                    <a href="{{ miniCartUpsellProduct.url }}">{{ miniCartUpsellProduct.title }}</a>
                    <span class="minicart__price">
                      <span class="jsPrice" data-product-id="{{ miniCartUpsellProduct.id }}">{{ miniCartUpsellProduct.price | money | strip_html }}</span> 
                    </span>
                    {% if miniCartUpsellProduct.variants.size > 1 %}
                      <select class="minicart__variant-dropdown" data-product-id="{{ miniCartUpsellProduct.id }}" onchange="BoosterTheme.cartUpsell.toggleUpsellVariantUI({{ miniCartUpsellProduct.id }},this.value, this.options[this.selectedIndex].getAttribute('price'))">
                        {% for variant_option in miniCartUpsellProduct.variants %}
                       
                          {% if variant_option.available %}
                            <option value="{{ variant_option.id }}" price="{{ variant_option.price | money | strip_html}}">
                              {{ variant_option.title | truncate: 20, '...' }}
                            </option>
                          {% else %}
                            <option disabled>{{ variant_option.title | truncate: 20, '...' }} - {{'general.buttons.sold_out' | t}}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    {% endif %}
                    <div class="quantity--input">
                      <button class="cart-upsell quantity--input__button quantity--input__incr" onclick="BoosterTheme.cartUpsell.quantityHandler(event, false, {{miniCartUpsellProduct.id}})">-</button><!--
                      --><input class="cart-upsell quantity--input__input" data-cart-upsell-quantity-id="{{ miniCartUpsellProduct.id }}" value="1" ><!--
                      --><button class="cart-upsell quantity--input__button quantity--input__decr"onclick="BoosterTheme.cartUpsell.quantityHandler(event, true, {{miniCartUpsellProduct.id}})">+</button>
                    </div>
                  </div>
                  <div class="minicart__upsell--button"> 
                    {% assign text = 'upsell.add_to_cart' | t  %}
                    {% render 'add-to-cart-button-upsell', product:miniCartUpsellProduct.id ,variant: miniCartUpsellProduct.first_available_variant.id, quantity: 1, price: miniCartUpsellProduct.price, text: text %}
                  </div>
                </div>
                {% assign products_shown = products_shown | plus: 1 %}
                {% if products_shown >= length %}{% break %}{% endif %}
              {% endunless %}
            {% endif %}
          {% endfor %}

        </div>
      {% endunless %}
    {% endif %}
  </div>
  {% unless cart.items.size == 0 %}
  <div class="minicart__bottom">
    <span class="minicart__total">Total: <span class="jsPrice">{{ cart.total_price | money | strip_html }}</span></span>
    {% assign root_url = routes.root_url %}
    {% assign checkout_url = root_url | append: 'checkout' %}
    {% if root_url != '/' %}
      {% assign checkout_url = root_url | append: '/checkout' %}
    {% endif %}
    <a class="button button--primary button--filled button--primary__filled button--full-width" href="{{ checkout_url }}">{{'general.buttons.checkout' | t}}</a>
    <a style="margin-top: 0.75rem; font-size: 0.9em; padding: 0.25rem" class="button button--primary button--text button--text button--full-width" href="{{ routes.cart_url }}">{{ 'general.buttons.view_cart' | t }}</a>
  </div>
  {% endunless %}
</div>
{% endcapture %}

{% capture itemsjson %}
{
{%- for item in cart.items %}
"{{item.variant_id}}": {"quantity": {{item.quantity}}, "info": {{item|json}}}{% unless forloop.last %},{% endunless%}
{% endfor -%}
}
{% endcapture %}


<div>
{
  "html": {{cartHTML | json}},
  "item_count": {{cart.item_count}},
  "items": {{itemsjson | json}},
  "total": "{{cart.total_price | money | strip_html}}",
  "total_raw": {{cart.total_price}}
}
</div>